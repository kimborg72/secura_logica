---
import PageLayout from '@layouts/PageLayout.astro';
import HeroSimple from '@components/sections/HeroSimple.astro';
import ServiceCard from '@components/ui/ServiceCard.astro';
import Button from '@components/ui/Button.astro';
import CTABanner from '@components/sections/CTABanner.astro';
import JsonLd from '@components/seo/JsonLd.astro';
import { site, organizationSchema } from '@data/site';
import { getServicesByLocale } from '@i18n/content';
import { getServicePath, getServicesPath, getContactPath, getSecurapilotPath } from '@i18n/routes';
import { t } from '@i18n/index';

const locale = 'sv';

export async function getStaticPaths() {
  const services = await getServicesByLocale('sv');
  return services.map((service) => ({
    params: { slug: service.data.slug },
    props: { service },
  }));
}

const { service } = Astro.props;
const { data } = service;

const allServices = await getServicesByLocale(locale);
const relatedServices = allServices.filter((s) =>
  data.relatedServices.includes(s.data.slug),
);

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: data.title,
  description: data.metaDescription,
  provider: {
    '@type': 'Organization',
    name: organizationSchema.name,
    url: organizationSchema.url,
  },
  areaServed: { '@type': 'Country', name: 'Sweden' },
  url: `${site.url}${getServicePath(locale, data.slug)}`,
};

const faqSchema = data.faq?.length ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: data.faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
} : null;
---

<PageLayout title={data.metaTitle} description={data.metaDescription} locale={locale}>
  <JsonLd schema={serviceSchema} />
  {faqSchema && <JsonLd schema={faqSchema} />}
  <HeroSimple
    title={data.title}
    description={data.excerpt}
    breadcrumbs={[
      { label: t(locale, 'services.overline'), href: getServicesPath(locale) },
      { label: data.shortTitle },
    ]}
    locale={locale}
  />

  <!-- Introduction -->
  <section class="section">
    <div class="container">
      <div class="grid lg:grid-cols-5 gap-12">
        <div class="lg:col-span-3" data-reveal>
          <p class="overline mb-4">{t(locale, 'serviceDetail.aboutService')}</p>
          {data.introLead && (
            <p class="lead text-slate mb-6">{data.introLead}</p>
          )}
          {data.introduction.split('\n\n').map((paragraph: string) => (
            <p class="text-gray leading-relaxed mb-4">{paragraph}</p>
          ))}
        </div>
        <div class="lg:col-span-2" data-reveal="right">
          <div class="bg-surface rounded-xl p-6 border border-border lg:sticky lg:top-28">
            <h3 class="text-lg font-semibold text-navy mb-4">{t(locale, 'serviceDetail.quickFacts')}</h3>
            <dl class="space-y-4 text-sm">
              <div>
                <dt class="font-medium text-navy">{t(locale, 'serviceDetail.deliverables')}</dt>
                <dd class="text-gray mt-0.5">{data.deliverables.length} {t(locale, 'serviceDetail.deliverablesCount')}</dd>
              </div>
              <div>
                <dt class="font-medium text-navy">{t(locale, 'serviceDetail.process')}</dt>
                <dd class="text-gray mt-0.5">{data.process.length} {t(locale, 'serviceDetail.processSteps')}</dd>
              </div>
              {relatedServices.length > 0 && (
                <div>
                  <dt class="font-medium text-navy">{t(locale, 'serviceDetail.combinedWith')}</dt>
                  <dd class="text-gray mt-0.5">{relatedServices.map((s) => s.data.shortTitle).join(', ')}</dd>
                </div>
              )}
            </dl>
            <div class="mt-6 pt-6 border-t border-border">
              <Button href={getContactPath(locale)} variant="primary" size="md" class="w-full justify-center">
                {t(locale, 'serviceDetail.bookCall')}
              </Button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Target Audience -->
  {data.targetAudience && (
    <section class="section-sm bg-surface">
      <div class="container">
        <div class="max-w-3xl mb-10" data-reveal>
          <p class="overline mb-3">{t(locale, 'serviceDetail.targetAudience')}</p>
          <h2 class="mb-4">{data.targetAudience.heading}</h2>
          <p class="text-lg text-slate leading-relaxed">{data.targetAudience.description}</p>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-reveal>
          {data.targetAudience.segments.map((segment: string, i: number) => (
            <div class="flex items-center gap-3 bg-white rounded-lg px-5 py-4 border border-border" data-delay={String((i % 3) + 1)}>
              <div class="w-2 h-2 rounded-full bg-teal shrink-0"></div>
              <span class="text-sm font-medium text-navy">{segment}</span>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Benefits -->
  <section class="section">
    <div class="container">
      <div class="max-w-2xl mb-12" data-reveal>
        <p class="overline mb-3">{t(locale, 'serviceDetail.benefits')}</p>
        <h2>{t(locale, 'serviceDetail.whyWith', { service: data.shortTitle })}</h2>
      </div>
      <div class="grid md:grid-cols-3 gap-8">
        {data.benefits.map((benefit: any, i: number) => (
          <div class="relative" data-reveal data-delay={String(i + 1)}>
            <div class="text-5xl font-bold text-navy/10 mb-3 leading-none">
              {String(i + 1).padStart(2, '0')}
            </div>
            <h3 class="text-lg font-semibold text-navy mb-2">{benefit.title}</h3>
            <p class="text-sm text-gray leading-relaxed">{benefit.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Process -->
  <section class="section-sm bg-surface">
    <div class="container">
      <div class="text-center max-w-2xl mx-auto mb-16" data-reveal>
        <p class="overline mb-3">{t(locale, 'serviceDetail.workMethod')}</p>
        <h2>{t(locale, 'serviceDetail.ourProcess')}</h2>
      </div>

      <!-- Desktop: horizontal timeline -->
      <div class="hidden md:block" data-reveal>
        <div class="grid grid-cols-4 gap-0 relative">
          <div class="absolute top-6 left-[12.5%] right-[12.5%] h-px bg-border"></div>
          {data.process.map((step: any) => (
            <div class="relative text-center px-4">
              <div class="w-12 h-12 mx-auto flex items-center justify-center rounded-full bg-navy text-white font-bold text-lg relative z-10">
                {step.step}
              </div>
              <h3 class="text-base font-semibold text-navy mt-4 mb-2">{step.title}</h3>
              <p class="text-sm text-gray leading-relaxed">{step.description}</p>
              {step.duration && (
                <span class="inline-block mt-2 text-xs font-medium text-accent-dark bg-accent/15 px-2 py-1 rounded">
                  {step.duration}
                </span>
              )}
            </div>
          ))}
        </div>
      </div>

      <!-- Mobile: vertical steps -->
      <div class="md:hidden space-y-6">
        {data.process.map((step: any) => (
          <div class="flex gap-4" data-reveal>
            <div class="shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-navy text-white font-bold">
              {step.step}
            </div>
            <div class="pt-0.5">
              <h3 class="font-semibold text-navy mb-1">{step.title}</h3>
              <p class="text-sm text-gray">{step.description}</p>
              {step.duration && (
                <span class="inline-block mt-1 text-xs font-medium text-accent-dark">{step.duration}</span>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Securapilot Connection -->
  {data.securapilotConnection && (
    <section class="bg-navy-dark relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgba(243,255,175,0.3) 1px, transparent 0); background-size: 40px 40px;"></div>
      </div>
      <div class="container section relative z-10">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
          <div data-reveal>
            <p class="overline mb-3" style="color: var(--color-accent)">Securapilot</p>
            <h2 class="text-white mb-4">{data.securapilotConnection.heading}</h2>
            <p class="text-lg text-white/60 leading-relaxed mb-8">{data.securapilotConnection.description}</p>
            <Button href={getSecurapilotPath(locale)} variant="primary" size="md">
              {t(locale, 'serviceDetail.explorePilot')}
            </Button>
          </div>
          <div data-reveal="right">
            <ul class="space-y-4">
              {data.securapilotConnection.features.map((feature: string) => (
                <li class="flex items-start gap-3 bg-white/5 rounded-lg px-5 py-4">
                  <div class="w-2 h-2 rounded-full bg-accent shrink-0 mt-2"></div>
                  <span class="text-white/80">{feature}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Deliverables & FAQ -->
  <section class="section">
    <div class="container">
      <div class={`grid gap-16 ${data.faq?.length ? 'lg:grid-cols-2' : ''}`}>
        <div data-reveal>
          <p class="overline mb-3">{t(locale, 'serviceDetail.results')}</p>
          <h2 class="mb-8">{t(locale, 'serviceDetail.whatYouGet')}</h2>
          <ul class="space-y-4">
            {data.deliverables.map((item: string) => (
              <li class="flex items-start gap-3 pb-4 border-b border-border last:border-0">
                <div class="w-2 h-2 rounded-full bg-teal shrink-0 mt-2"></div>
                <span class="text-slate">{item}</span>
              </li>
            ))}
          </ul>
        </div>

        {data.faq && data.faq.length > 0 && (
          <div data-reveal="right">
            <p class="overline mb-3">{t(locale, 'serviceDetail.faqOverline')}</p>
            <h2 class="mb-8">{t(locale, 'serviceDetail.faqTitle')}</h2>
            <div class="space-y-3">
              {data.faq.map((item: any) => (
                <details class="group bg-surface rounded-lg border border-border">
                  <summary class="flex items-center justify-between px-5 py-4 cursor-pointer text-navy font-medium text-sm">
                    {item.question}
                    <svg class="w-5 h-5 text-gray shrink-0 ml-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </summary>
                  <div class="px-5 pb-4 text-sm text-gray leading-relaxed">
                    {item.answer}
                  </div>
                </details>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Related Services -->
  {relatedServices.length > 0 && (
    <section class="section-sm bg-surface">
      <div class="container">
        <h2 class="mb-10" data-reveal>{t(locale, 'serviceDetail.relatedServices')}</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedServices.map((s, i) => (
            <div data-reveal data-delay={String(i + 1)}>
              <ServiceCard
                title={s.data.title}
                description={s.data.excerpt}
                href={getServicePath(locale, s.data.slug)}
                locale={locale}
              />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <CTABanner
    title={data.ctaText || t(locale, 'cta.defaultTitle')}
    description={data.ctaDescription || t(locale, 'cta.defaultDescription')}
    locale={locale}
  />
</PageLayout>
