---
import PageLayout from '@layouts/PageLayout.astro';
import HeroSimple from '@components/sections/HeroSimple.astro';
import Badge from '@components/ui/Badge.astro';
import AuthorCard from '@components/ui/AuthorCard.astro';
import CTABanner from '@components/sections/CTABanner.astro';
import JsonLd from '@components/seo/JsonLd.astro';
import { render } from 'astro:content';
import { site, organizationSchema } from '@data/site';
import { getReadingTime, formatReadingTime } from '@utils/reading-time';
import { getInsightsByLocale } from '@i18n/content';
import { getInsightPath, getInsightsPath } from '@i18n/routes';
import { formatDate, t } from '@i18n/index';
import { getTeamByLocale } from '@i18n/content';

const locale = 'sv';

export async function getStaticPaths() {
  const insights = await getInsightsByLocale('sv');
  return insights.map((post) => ({
    params: { slug: post.id.replace('sv/', '') },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const readingMinutes = getReadingTime(post.body || '');
const readingTimeText = formatReadingTime(readingMinutes, locale);

// Author data from team collection
const team = await getTeamByLocale(locale);
const authorData = team.find((member) => member.data.name === post.data.author);

// Related articles (exclude current, max 2)
const allInsights = (await getInsightsByLocale(locale))
  .filter((p) => p.id !== post.id)
  .slice(0, 2);

const wordCount = (post.body || '').trim().split(/\s+/).length;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date.toISOString(),
  wordCount,
  articleSection: post.data.category,
  author: {
    '@type': 'Person',
    name: post.data.author,
  },
  publisher: {
    '@type': 'Organization',
    name: organizationSchema.name,
    url: organizationSchema.url,
    logo: { '@type': 'ImageObject', url: organizationSchema.logo },
  },
  url: `${site.url}${getInsightPath(locale, post.id.replace(`${locale}/`, ''))}`,
};
---

<PageLayout title={post.data.title} description={post.data.description} locale={locale}>
  <JsonLd schema={articleSchema} />

  <!-- Reading progress bar -->
  <div
    id="reading-progress"
    class="fixed top-0 left-0 h-[3px] bg-accent z-[60] origin-left pointer-events-none"
    style="transform: scaleX(0); will-change: transform;"
    aria-hidden="true"
  ></div>

  <HeroSimple
    title={post.data.title}
    breadcrumbs={[
      { label: t(locale, 'insights.overline'), href: getInsightsPath(locale) },
      { label: post.data.title },
    ]}
    locale={locale}
  />

  <article class="section" id="article-content">
    <div class="container">
      <div class="max-w-[680px] mx-auto">
        <!-- Metadata -->
        <div class="flex flex-wrap items-center gap-x-3 gap-y-2 mb-10" data-reveal>
          <Badge text={post.data.category} variant="copper" />
          <span class="text-gray-light text-sm">&middot;</span>
          <time class="text-sm text-gray" datetime={post.data.date.toISOString()}>
            {formatDate(post.data.date, locale)}
          </time>
          <span class="text-gray-light text-sm">&middot;</span>
          <span class="text-sm text-gray">{readingTimeText}</span>
        </div>

        <!-- Article body -->
        <div class="prose" data-reveal>
          <Content />
        </div>

        <!-- Author -->
        {authorData && (
          <div class="border-t border-border mt-12 pt-8" data-reveal>
            <p class="overline mb-4">{t(locale, 'insightDetail.author')}</p>
            <AuthorCard
              name={authorData.data.name}
              role={authorData.data.role}
              bio={authorData.data.bio}
              linkedin={authorData.data.linkedin}
              locale={locale}
            />
          </div>
        )}
      </div>

      <!-- Related articles -->
      {allInsights.length > 0 && (
        <div class="max-w-[680px] mx-auto border-t border-border mt-12 pt-12" data-reveal>
          <p class="overline mb-3">Fler insikter</p>
          <h2 class="mb-8">Relaterade artiklar</h2>
          <div class="grid sm:grid-cols-2 gap-8">
            {allInsights.map((item) => (
              <article class="group">
                <a href={getInsightPath(locale, item.id.replace(`${locale}/`, ''))} class="block">
                  <div class="aspect-[16/10] rounded-xl bg-surface mb-4 overflow-hidden">
                    <div class="w-full h-full bg-gradient-to-br from-navy/5 to-accent/5 group-hover:scale-105 transition-transform duration-500"></div>
                  </div>
                  <div class="flex items-center gap-3 mb-2">
                    <Badge text={item.data.category} variant="copper" />
                    <time class="text-xs text-gray" datetime={item.data.date.toISOString()}>
                      {formatDate(item.data.date, locale)}
                    </time>
                  </div>
                  <h3 class="text-lg font-semibold text-navy group-hover:text-accent-dark transition-colors mb-1">
                    {item.data.title}
                  </h3>
                  <p class="text-sm text-gray leading-relaxed">{item.data.description}</p>
                </a>
              </article>
            ))}
          </div>
        </div>
      )}
    </div>
  </article>

  <CTABanner locale={locale} />
</PageLayout>

<style is:global>
  /* Prose typography â€” article body */
  .prose h2, .prose h3, .prose h4 {
    font-family: var(--font-sans);
    color: var(--color-dark);
  }

  .prose h2 {
    font-size: clamp(1.5rem, 2vw, 1.75rem);
    font-weight: 700;
    line-height: 1.2;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .prose h3 {
    font-size: clamp(1.25rem, 1.5vw, 1.375rem);
    font-weight: 600;
    line-height: 1.3;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose h4 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .prose p {
    color: var(--color-slate);
    font-size: clamp(1.0625rem, 1.2vw, 1.1875rem);
    line-height: 1.8;
    margin-bottom: 1.5rem;
  }

  .prose ul {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .prose ol {
    list-style-type: decimal;
    padding-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .prose li {
    color: var(--color-slate);
    font-size: clamp(1.0625rem, 1.2vw, 1.1875rem);
    line-height: 1.75;
    margin-bottom: 0.5rem;
  }

  .prose li > ul,
  .prose li > ol {
    margin-top: 0.5rem;
    margin-bottom: 0;
  }

  .prose strong {
    color: var(--color-dark);
    font-weight: 600;
  }

  .prose a {
    color: var(--color-accent-dark);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: opacity 0.15s;
  }

  .prose a:hover {
    opacity: 0.8;
  }

  /* Tables */
  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin-block: 2rem;
    font-size: 0.9375rem;
  }

  .prose thead {
    background: var(--color-surface);
  }

  .prose th {
    text-align: left;
    font-weight: 600;
    color: var(--color-dark);
    padding: 0.75rem 1rem;
    border-bottom: 2px solid var(--color-border);
  }

  .prose td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-slate);
  }

  .prose tr:last-child td {
    border-bottom: none;
  }

  /* Blockquote */
  .prose blockquote {
    border-left: 3px solid var(--color-accent);
    padding-left: 1.5rem;
    margin-block: 1.5rem;
    font-style: italic;
    color: var(--color-gray);
  }

  .prose blockquote p {
    color: var(--color-gray);
  }

  /* Horizontal rule */
  .prose hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin-block: 2.5rem;
  }

  /* Inline code */
  .prose code {
    background: var(--color-surface);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  /* Code blocks */
  .prose pre {
    background: var(--color-dark);
    color: var(--color-surface);
    padding: 1.25rem 1.5rem;
    border-radius: 0.75rem;
    overflow-x: auto;
    margin-block: 2rem;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .prose pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
  }

  /* Images */
  .prose img {
    border-radius: 0.75rem;
    margin-block: 2rem;
  }
</style>

<script>
  let progressCleanup: (() => void) | null = null;

  function initProgress() {
    if (progressCleanup) progressCleanup();

    const bar = document.getElementById('reading-progress');
    const article = document.getElementById('article-content');
    if (!bar || !article) return;

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      bar.style.display = 'none';
      return;
    }

    function onScroll() {
      const rect = article!.getBoundingClientRect();
      const total = rect.height - window.innerHeight;
      if (total <= 0) {
        bar!.style.transform = 'scaleX(1)';
        return;
      }
      const progress = Math.min(Math.max(-rect.top / total, 0), 1);
      bar!.style.transform = `scaleX(${progress})`;
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();

    progressCleanup = () => {
      window.removeEventListener('scroll', onScroll);
    };
  }

  initProgress();
  document.addEventListener('astro:after-swap', initProgress);
</script>
