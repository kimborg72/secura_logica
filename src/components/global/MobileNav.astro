---
import { getMainNav } from '@data/navigation';
import { offices } from '@data/offices';
import LanguageSwitcher from './LanguageSwitcher.astro';
import type { Locale } from '@i18n/types';
import { t } from '@i18n/index';
import { getContactPath } from '@i18n/routes';

interface Props {
  locale?: Locale;
}

const { locale = 'sv' } = Astro.props;
const nav = getMainNav(locale);
---

<div
  id="mobile-nav"
  class="fixed inset-0 z-40 bg-white transform translate-x-full transition-transform duration-300 lg:hidden"
  aria-hidden="true"
>
  <div class="flex flex-col h-full pt-24 pb-8 px-6 overflow-y-auto">
    <nav class="flex-1" aria-label={t(locale, 'nav.mobileNav')}>
      <ul class="space-y-1">
        {nav.map((item) => (
          <li>
            {item.children ? (
              <details class="group">
                <summary class="flex items-center justify-between py-3 text-lg font-medium text-navy cursor-pointer">
                  {item.label}
                  <svg class="w-5 h-5 text-gray transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <ul class="pl-4 pb-2 space-y-1">
                  {item.children.map((child) => (
                    <li>
                      <a
                        href={child.href}
                        class="block py-2 text-base text-slate hover:text-accent-dark transition-colors"
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            ) : (
              <a
                href={item.href}
                class="block py-3 text-lg font-medium text-navy hover:text-accent-dark transition-colors"
              >
                {item.label}
              </a>
            )}
          </li>
        ))}
      </ul>
    </nav>

    <!-- Language Switcher -->
    <div class="mt-6 pt-6 border-t border-border">
      <LanguageSwitcher locale={locale} />
    </div>

    <!-- CTA -->
    <div class="mt-6 pt-6 border-t border-border">
      <a
        href={getContactPath(locale)}
        class="block w-full text-center px-6 py-3 bg-accent text-dark font-semibold rounded-lg hover:bg-accent-hover transition-colors"
      >
        {t(locale, 'header.contactUs')}
      </a>
    </div>

    <!-- Offices -->
    <div class="mt-6 pt-6 border-t border-border">
      <p class="overline mb-3">{t(locale, 'footer.offices')}</p>
      <div class="flex gap-6 text-sm text-gray">
        {offices.map((office) => (
          <div>
            <p class="font-medium text-navy">{office.city}</p>
            <p>{office.phone}</p>
          </div>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  function initMobileNav() {
    const toggle = document.querySelector('[data-mobile-toggle]');
    const nav = document.getElementById('mobile-nav');
    if (!toggle || !nav) return;

    function open() {
      nav!.classList.remove('translate-x-full');
      nav!.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');
      document.body.classList.add('mobile-open');
      document.body.style.overflow = 'hidden';
    }

    function close() {
      nav!.classList.add('translate-x-full');
      nav!.setAttribute('aria-hidden', 'true');
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('mobile-open');
      document.body.style.overflow = '';
    }

    toggle.addEventListener('click', () => {
      const isOpen = !nav!.classList.contains('translate-x-full');
      isOpen ? close() : open();
    });

    // Close on link click
    nav!.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', close);
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  }

  initMobileNav();
  document.addEventListener('astro:after-swap', initMobileNav);
</script>
